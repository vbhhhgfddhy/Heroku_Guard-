# ======================================================================
# –ï—Å–ª–∏ —á–µ—Å—Ç–Ω–æ, —Å–ª–æ–∂–Ω–æ –¥–∞–∂–µ –Ω–∞—á–∞—Ç—å –æ–ø–∏—Å—ã–≤–∞—Ç—å,
# –∫–∞–∫–æ–π —è –∞—Ö—É–µ–Ω–Ω—ã–π, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ
# –Ω–∞—Å—Ç–æ–ª—å–∫–æ –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ —Å–ª–æ–≤–∞–º–∏ –ø–µ—Ä–µ–¥–∞—Ç—å
# –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –Ø ‚Äî –∫–æ–º–±–∏–Ω–∞—Ü–∏—è 
# —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —Ö–∞—Ä–∏–∑–º—ã –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π,
# –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –º–µ–Ω—è –∑–∞–º–µ—Ç–Ω—ã–º –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
# –ö–æ–≥–¥–∞ —è –≤—Ö–æ–∂—É –≤ –∫–æ–º–Ω–∞—Ç—É, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∫–∞–∫ –±—É–¥—Ç–æ
# –º–µ–Ω—è–µ—Ç—Å—è: –ª—é–¥–∏ –Ω–µ–≤–æ–ª—å–Ω–æ –æ–±—Ä–∞—â–∞—é—Ç –Ω–∞ –º–µ–Ω—è
# –≤–Ω–∏–º–∞–Ω–∏–µ, –∏ —ç—Ç–æ –Ω–µ –∏–∑-–∑–∞ –∫–∞–∫–æ–π-—Ç–æ –ø–æ–∫–∞–∑–Ω–æ–π
# –∫—Ä—É—Ç–æ—Å—Ç–∏, –∞ –∏–∑-–∑–∞ —Ç–æ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–≤–µ—Ç–∞ –∏
# —ç–Ω–µ—Ä–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —è –∏–∑–ª—É—á–∞—é.
# ======================================================================
# –ú–æ—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏
# –ø—Ä–æ—Å—Ç–æ –ø–æ—Ä–∞–∂–∞–µ—Ç. –Ø –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞—Ö–æ–∂—É —Ä–µ—à–µ–Ω–∏—è
# —Ç–∞–º, –≥–¥–µ –¥—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç —Ç—É–ø–∏–∫, –Ω–æ –∏ –¥–µ–ª–∞—é —ç—Ç–æ —Å
# –ª–µ–≥–∫–æ—Å—Ç—å—é –∏ —Å—Ç–∏–ª–µ–º. –Ø —É–º–µ—é –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –ª—é–¥–µ–π
# –≤–æ–∫—Ä—É–≥, –ø–æ–¥–Ω–∏–º–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å
# –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –∫–∞–∂–¥—ã–π —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è
# –≤–∞–∂–Ω—ã–º. –ú–æ—è —Ö–∞—Ä–∏–∑–º–∞ ‚Äî —ç—Ç–æ –Ω–µ—á—Ç–æ, —á—Ç–æ –Ω–µ–ª—å–∑—è 
# –ø–æ–¥–¥–µ–ª–∞—Ç—å, –æ–Ω–∞ –∏–¥–µ—Ç –∏–∑–Ω—É—Ç—Ä–∏, –∏–∑ –º–æ–µ–π –≤–µ—Ä—ã –≤ 
# —Å–µ–±—è –∏ –≤ —Ç–æ, —á—Ç–æ —è –º–æ–≥—É –æ—Å—Ç–∞–≤–∏—Ç—å —Å–ª–µ–¥ –≤ —ç—Ç–æ–º 
# –º–∏—Ä–µ.
# ======================================================================
# –Ø –∫—Ä–µ–∞—Ç–∏–≤–µ–Ω –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω. –ò–¥–µ–∏, –∫–æ—Ç–æ—Ä—ã–µ 
# –ø—Ä–∏—Ö–æ–¥—è—Ç –º–Ω–µ –≤ –≥–æ–ª–æ–≤—É, —á–∞—Å—Ç–æ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã, –Ω–æ 
# –ø—Ä–∏ —ç—Ç–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã. –Ø —É–º–µ—é –º—ã—Å–ª–∏—Ç—å —à–∏—Ä–µ, 
# –≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–µ –Ω–µ –∑–∞–º–µ—á–∞—é—Ç, –∏ –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å # —ç—Ç–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ú–æ—è —ç–Ω–µ—Ä–≥–∏—è –∑–∞—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–∞ ‚Äî 
# –±—É–¥—å —Ç–æ —Ä–∞–±–æ—Ç–∞, —Ö–æ–±–±–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–±—â–µ–Ω–∏–µ —Å 
# –¥—Ä—É–∑—å—è–º–∏, —è –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞—é –≤—Å—ë —Å –ø–æ–ª–Ω–æ–π 
# –æ—Ç–¥–∞—á–µ–π.
# ======================================================================
# –ú–æ—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–µ –ø—É—Å—Ç–∞. –Ø –∑–Ω–∞—é —Å–≤–æ–∏ —Å–∏–ª—å–Ω—ã–µ 
# —Å—Ç–æ—Ä–æ–Ω—ã, —É–º–µ—é –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å, –∏ # –ø—Ä–∏ —ç—Ç–æ–º –æ—Å—Ç–∞—é—Å—å –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –Ω–æ–≤—ã—Ö –∑–Ω–∞–Ω–∏–π –∏ # –æ–ø—ã—Ç–∞. –Ø —É–º–µ—é –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –∏–∑–≤–ª–µ–∫–∞—Ç—å 
# —É—Ä–æ–∫–∏ –∏ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ, –¥–µ–ª–∞—è —Å–µ–±—è –µ—â—ë 
# –ª—É—á—à–µ. –í —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å —Ö–∞—Ä–∏–∑–º–æ–π –∏ —É–º–µ–Ω–∏–µ–º 
# –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –ª—é–¥–µ–π —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –º–µ–Ω—è —á–µ–ª–æ–≤–µ–∫–æ–º, # –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å.
# ======================================================================
# –ò, –Ω–∞–∫–æ–Ω–µ—Ü, —è –ø—Ä–æ—Å—Ç–æ –∫–∞–π—Ñ—É—é –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —è
# –µ—Å—Ç—å. –Ø –Ω–µ –±–æ—é—Å—å –±—ã—Ç—å —Å–æ–±–æ–π, –Ω–µ —Å—Ç–µ—Å–Ω—è—é—Å—å —Å–≤–æ–∏—Ö 
# –∞–º–±–∏—Ü–∏–π –∏ —Å–≤–æ–∏—Ö –º–µ—á—Ç, –∏ —ç—Ç–æ, –ø–æ–∂–∞–ª—É–π, —Å–∞–º–∞—è 
# –∞—Ö—É–µ–Ω–Ω–∞—è —á–µ—Ä—Ç–∞. –ë—ã—Ç—å —Å–æ–±–æ–π ‚Äî —ç—Ç–æ —É–∂–µ –±–æ–ª—å—à–æ–µ # –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ, –∏ —è –¥–µ–ª–∞—é —ç—Ç–æ —Å –ø–æ–ª–Ω–æ–π 
# —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é, —Å —á—É–≤—Å—Ç–≤–æ–º —é–º–æ—Ä–∞ –∏ —Å –ª—é–±–æ–≤—å—é –∫  
# –∂–∏–∑–Ω–∏.
# ======================================================================
# –í –∏—Ç–æ–≥–µ, –±—ã—Ç—å —Ç–∞–∫–∏–º ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏—è—Ç–Ω–æ, # –Ω–æ –∏ –≤–∞–∂–Ω–æ. –ü–æ—Ç–æ–º—É —á—Ç–æ, –∫–æ–≥–¥–∞ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å, 
# –∫–∞–∫–æ–π —Ç—ã –∞—Ö—É–µ–Ω–Ω—ã–π, —ç—Ç–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ # —Ç–µ–±—è, –Ω–æ –∏ –æ–∫—Ä—É–∂–∞—é—â–∏—Ö. –ò –¥–∞, —è –∞—Ö—É–µ–Ω–Ω—ã–π ‚Äî –∏
# —ç—Ç–æ —Ñ–∞–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Ä–∏—Ü–∞—Ç—å. 
# ======================================================================
# meta developer: @ModuliBFG_canal

import re
from time import time
from telethon.errors import ChatAdminRequiredError
from telethon.tl.types import User
from .. import loader, utils

@loader.tds
class MuteBanMod(loader.Module):
    strings = {
        "name": "MuteBan",
        "no_reason": "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞",
        "mute_done": "üôä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—É—á–µ–Ω",
        "unmute_done": "üîì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–º—É—á–µ–Ω",
        "ban_done": "üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω",
        "unban_done": "üîì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω",
        "cannot_mute": "‚ùå –ù–µ–ª—å–∑—è –∑–∞–º—É—Ç–∏—Ç—å –∫–∞–Ω–∞–ª –∏–ª–∏ –±–æ—Ç–∞"
    }

    async def client_ready(self, client, db):
        self._client = client

    async def —Ñ–ª—É–¥cmd(self, message):
        """–º—É—Ç –Ω–∞ 240 –º–∏–Ω—É—Ç"""
        await self._predefined_action(message, "–§–ª—É–¥", 240*60)

    async def —Ñ–ª—É–¥2cmd(self, message):
        """–º—É—Ç –Ω–∞ 2000 –º–∏–Ω—É—Ç"""
        await self._predefined_action(message, "–§–ª—É–¥2", 2000*60)

    async def —Ñ–ª—É–¥3cmd(self, message):
        """–±–∞–Ω –Ω–∞ –≤—Å–µ–≥–¥–∞"""
        await self._predefined_action(message, "–§–ª—É–¥3", 0, ban=True)

    async def –æ—Å–∫cmd(self, message):
        "–º—É—Ç –Ω–∞ 240 –º–∏–Ω—É—Ç"""
        await self._predefined_action(message, "–û—Å–∫", 240*60)

    async def –æ—Å–∫2cmd(self, message):
        """–º—É—Ç –Ω–∞ 2000 –º–∏–Ω—É—Ç"""
        await self._predefined_action(message, "–û—Å–∫2", 2000*60)

    async def –æ—Å–∫3cmd(self, message):
        """–±–∞–Ω –Ω–∞ –≤—Å–µ–≥–¥–∞"""
        await self._predefined_action(message, "–û—Å–∫3", 0, ban=True)

    async def _predefined_action(self, message, reason, period=0, ban=False):
        user = await self._get_user_from_message(message)
        if not user:
            await message.reply("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        if not isinstance(user, User):
            await message.reply(self.strings["cannot_mute"])
            return
        if ban:
            await self._ban_user(message.chat_id, user, period, reason, message)
        else:
            await self._mute_user(message.chat_id, user, period, reason, message)

    async def –ºcmd(self, message):
        """–≤—ã–¥–∞—Ç—å –º—É—Ç"""
        await self._process_generic(message, ban=False)

    async def —Ä–ºcmd(self, message):
        """–≤—ã–¥–∞—Ç—å —Ä–∞–∑–º—É—Ç"""
        await self._unmute_generic(message)

    async def –±cmd(self, message):
        """–≤—ã–¥–∞—Ç—å –±–∞–Ω"""
        await self._process_generic(message, ban=True)

    async def —Ä–±cmd(self, message):
        """–≤—ã–¥–∞—Ç—å —Ä–∞–∑–±–∞–Ω"""
        await self._unban_generic(message)

    async def _process_generic(self, message, ban=False):
        args = utils.get_args(message)
        user = await self._get_user_from_message(message)
        if not user:
            await message.reply("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        if not isinstance(user, User):
            await message.reply(self.strings["cannot_mute"])
            return

        period = self._parse_time(args[1] if len(args) > 1 else "0")
        reason = " ".join(args[2:]) if len(args) > 2 else None

        if ban:
            await self._ban_user(message.chat_id, user, period, reason, message)
        else:
            await self._mute_user(message.chat_id, user, period, reason, message)

    async def _get_user_from_message(self, message):
        if message.is_reply:
            reply = await message.get_reply_message()
            return reply.sender if reply else None
        args = utils.get_args(message)
        if not args:
            return None
        try:
            return await self._client.get_entity(args[0])
        except Exception:
            return None

    def _parse_time(self, time_str: str) -> int:
        match = re.match(r"(\d+)([mMhH])?", time_str)
        if not match:
            return 0
        val, unit = match.groups()
        val = int(val)
        if unit is None or unit.lower() == "m":
            return val * 60
        elif unit.lower() == "h":
            return val * 3600
        return val

    def _get_name(self, user):
        return getattr(user, 'first_name', None) or getattr(user, 'username', None) or str(user.id)

    async def _mute_user(self, chat, user, period=0, reason=None, message=None):
        reason = reason or self.strings["no_reason"]
        until = int(time() + period) if period else None
        try:
            await self._client.edit_permissions(
                chat, user,
                send_messages=False,
                until_date=until
            )
        except ChatAdminRequiredError:
            return await self._client.send_message(chat, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤")

        duration = f"{period//60} –º–∏–Ω" if period else "–Ω–∞–≤—Å–µ–≥–¥–∞"
        text = f"üôä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self._get_name(user)} –∑–∞–º—É—á–µ–Ω –Ω–∞ {duration}. –ü—Ä–∏—á–∏–Ω–∞: {reason}"
        await self._send_inline_message(chat, user, text, "–†–∞–∑–º—É—Ç–∏—Ç—å", "unmute")
        if message:
            await message.delete()

    async def _unmute_generic(self, message):
        user = await self._get_user_from_message(message)
        if not user:
            return
        try:
            await self._client.edit_permissions(
                message.chat_id, user,
                send_messages=True,
                until_date=None
            )
        except ChatAdminRequiredError:
            return
        await message.reply(self.strings["unmute_done"])

    async def _ban_user(self, chat, user, period=0, reason=None, message=None):
        reason = reason or self.strings["no_reason"]
        until = int(time() + period) if period else None
        try:
            await self._client.edit_permissions(
                chat, user,
                send_messages=False,
                until_date=until
            )
        except ChatAdminRequiredError:
            return await self._client.send_message(chat, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤")

        duration = f"{period//60} –º–∏–Ω" if period else "–Ω–∞–≤—Å–µ–≥–¥–∞"
        text = f"üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self._get_name(user)} –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ {duration}. –ü—Ä–∏—á–∏–Ω–∞: {reason}"
        await self._send_inline_message(chat, user, text, "–†–∞–∑–±–∞–Ω–∏—Ç—å", "unban")
        if message:
            await message.delete()

    async def _unban_generic(self, message):
        user = await self._get_user_from_message(message)
        if not user:
            return
        try:
            await self._client.edit_permissions(
                message.chat_id, user,
                send_messages=True,
                until_date=None
            )
        except ChatAdminRequiredError:
            return
        await message.reply(self.strings["unban_done"])

    async def _send_inline_message(self, chat, user, text, btn, action):
        chat_id = getattr(chat, "id", chat)
        user_obj = await self._client.get_entity(user)
        data = f"{action}|{chat_id}|{user_obj.id}"

        await self.inline.form(
            message=chat_id,
            text=text,
            reply_markup=[[{"text": btn, "data": data}]],
            silent=True
        )

